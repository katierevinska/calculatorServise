# О проекте
В данном репозитории представлен учебный проект "Сервис подсчёта арифметических выражений".

Он представляет собой веб-сервис, с помощью которого пользователь, после аутентификации, отправляет арифметическое выражение по HTTP и получает в ответ его результат. Все выражения сохраняются в базе данных SQLite и привязаны к конкретному пользователю.

# Back-end часть
Состоит из 2 элементов:
*   **Оркестратор:** принимает арифметическое выражение от аутентифицированного пользователя, переводит его в набор последовательных задач, сохраняет выражение в базу данных и управляет его статусом. Также Оркестратор отвечает за регистрацию и аутентификацию пользователей с использованием JWT.
*   **Агент:** запрашивает задачи у Оркестратора (через `GET /internal/task/new`), выполняет их и возвращает результат (через `POST /internal/task`). При старте агент запускает несколько горутин-вычислителей.

# Детали использования

## Аутентификация и Управление пользователями

### Регистрация пользователя
Для начала работы с сервисом необходимо зарегистрироваться.

*   **URL:** `/api/v1/register`
*   **Метод:** `POST`
*   **Тело запроса (JSON):**
    ```json
    {
        "login": "your_login",
        "password": "your_password"
    }
    ```
*   **Ответ при успехе:**
    *   **Код:** `200 OK`
    *   **Тело ответа:** Пустое.
*   **Ответ при ошибке (например, пользователь уже существует):**
    *   **Код:** `409 Conflict`
    *   **Тело ответа (JSON):**
        ```json
        {
            "error": "User with this login already exists"
        }
        ```

### Вход пользователя (Получение JWT токена)
После регистрации пользователь может войти в систему для получения JWT токена, который будет использоваться для доступа к защищенным эндпоинтам.

*   **URL:** `/api/v1/login`
*   **Метод:** `POST`
*   **Тело запроса (JSON):**
    ```json
    {
        "login": "your_login",
        "password": "your_password"
    }
    ```
*   **Ответ при успехе:**
    *   **Код:** `200 OK`
    *   **Тело ответа (JSON):**
        ```json
        {
            "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxLCJleHAiOjE2Nz..."
        }
        ```
        (Сохраните этот токен для последующих запросов)
*   **Ответ при ошибке (неверный логин/пароль):**
    *   **Код:** `401 Unauthorized`
    *   **Тело ответа (JSON):**
        ```json
        {
            "error": "Invalid login or password"
        }
        ```

## Работа с арифметическими выражениями (Требуется JWT токен)

Для всех последующих запросов через Postman к `/api/v1/calculate` и `/api/v1/expressions` необходимо в заголовке `Authorization` передавать JWT токен, полученный при логине, в формате `Bearer <ваш_токен>`.

### Отправка выражения на вычисление
*   **URL:** `/api/v1/calculate`
*   **Метод:** `POST`
*   **Заголовки:**
    *   `Content-Type: application/json`
    *   `Authorization: Bearer <ваш_jwt_токен>`
*   **Тело запроса (JSON):**
    ```json
    {
        "expression": "2+2*4"
    }
    ```
    (значением `expression` может являться любая строка, представляющая арифметическое выражение)
*   **Ответ при успехе:**
    *   **Код:** `201 Created` (статус изменился с 200 на 201, что более корректно для создания ресурса)
    *   **Тело ответа (JSON):**
        ```json
        {
            "id": "<уникальный идентификатор выражения>"
        }
        ```
        По этому `id` можно узнавать состояние вычислений данного выражения.
*   **Ответ при ошибке валидации выражения:**
    *   **Код:** `422 Unprocessable Entity`
    *   **Тело ответа (JSON):**
        ```json
        {
            "error": "Expression is not valid"
        }
        ```
*   **Ответ при отсутствии/невалидном JWT токене:**
    *   **Код:** `401 Unauthorized`

Пример запроса с использованием `curl` (Windows, после получения токена):
```bash
# Сначала получаем токен (этот шаг здесь не показан, делается через /api/v1/login)
# Предположим, токен сохранен в переменной $TOKEN
curl --location "http://localhost:8080/api/v1/calculate" ^
--header "Content-Type: application/json" ^
--header "Authorization: Bearer %TOKEN%" ^
--data "{\"expression\": \"2+2*4\"}"
```
(Замените `%TOKEN%` на реальный токен. Для Linux/macOS используйте `$TOKEN`).

### Получение списка всех выражений пользователя
*   **URL:** `/api/v1/expressions`
*   **Метод:** `GET`
*   **Заголовки:**
    *   `Authorization: Bearer <ваш_jwt_токен>`
*   **Ответ при успехе:**
    *   **Код:** `200 OK`
    *   **Тело ответа (JSON):** Массив выражений, принадлежащих аутентифицированному пользователю.
        ```json
        [
            {
                "id": "id2",
                "expression": "40+50",
                "status": "calculated",
                "result": "90.0000000000",
                "created_at": "2023-10-27T12:00:00Z"
            },
            {
                "id": "id5",
                "expression": "100-10",
                "status": "in progress",
                "result": "",
                "created_at": "2023-10-27T12:05:00Z"
            }
        ]
        ```
*   **Ответ при отсутствии/невалидном JWT токене:**
    *   **Код:** `401 Unauthorized`

Пример запроса `curl`:
```bash
curl --location "http://localhost:8080/api/v1/expressions" ^
--header "Authorization: Bearer %TOKEN%"
```

### Получение выражения по его идентификатору
*   **URL:** `/api/v1/expressions/{id}` (где `{id}` - идентификатор выражения)
*   **Метод:** `GET`
*   **Заголовки:**
    *   `Authorization: Bearer <ваш_jwt_токен>`
*   **Ответ при успехе:**
    *   **Код:** `200 OK`
    *   **Тело ответа (JSON):**
        ```json
        {
            "id": "id14",
            "expression": "2*7",
            "status": "in progress",
            "result": "",
            "created_at": "2023-10-27T12:10:00Z"
        }
        ```
*   **Ответ при отсутствии выражения или если оно принадлежит другому пользователю:**
    *   **Код:** `404 Not Found`
*   **Ответ при отсутствии/невалидном JWT токене:**
    *   **Код:** `401 Unauthorized`

Пример запроса `curl`:
```bash
curl --location "http://localhost:8080/api/v1/expressions/id14" ^
--header "Authorization: Bearer %TOKEN%"
```

## Внутренние эндпоинты (для взаимодействия Оркестратора и Агента)

Эти эндпоинты используются для внутренней работы системы и не предназначены для прямого вызова пользователями.

### Получение задачи для выполнения Агентом
*   **URL:** `/internal/task/new`
*   **Метод:** `GET`
*   **Тело ответа (JSON) при наличии задачи:**
    ```json
    {
        "id": "<идентификатор задачи>",
        "arg1": "<имя первого аргумента или значение>",
        "arg2": "<имя второго аргумента или значение>",
        "operation": "<операция>",
        "operation_time": "<время выполнения операции в мс>"
    }
    ```
*   **Ответ при отсутствии задач:**
    *   **Код:** `404 Not Found`

### Прием результата обработки задачи от Агента
*   **URL:** `/internal/task`
*   **Метод:** `POST`
*   **Тело запроса (JSON):**
    ```json
    {
      "id": "<идентификатор выполненной задачи>",
      "result": "<результат вычисления>"
    }
    ```
*   **Ответ при успехе:**
    *   **Код:** `200 OK`

## Что может вызвать ошибку "Expression is not valid":
*   Выражение подразумевает деление на 0.
*   В выражении встречаются символы, не являющиеся числами, операторами (+, -, \*, /) или скобками.
*   Неверно расставленные скобки или другая некорректная структура выражения, не позволяющая его распарсить.

# Инструкция по запуску проекта:

1.  **Запуск Оркестратора:**
    В одном терминале из корневой папки проекта выполните команду:
    ```bash
    go run ./cmd/orchestrator/main.go
    ```

2.  **Запуск Агента (одного или нескольких):**
    В другом(их) терминале(ах) из корневой папки проекта выполните команду:
    ```bash
    go run ./cmd/agent/main.go
    ```

Время выполнения операций задается переменными среды в миллисекундах

- TIME_ADDITION_MS - время выполнения операции сложения в миллисекундах
- TIME_SUBTRACTION_MS - время выполнения операции вычитания в миллисекундах
- TIME_MULTIPLICATIONS_MS - время выполнения операции умножения в миллисекундах
- TIME_DIVISIONS_MS - время выполнения операции деления в миллисекундах

Убедитесь, что пакеты `github.com/mattn/go-sqlite3`, `github.com/stretchr/testify/assert`, `golang.org/x/crypto/bcrypt`, `github.com/golang-jwt/jwt/v5` установлены (`go get ...`), команду выполнить если компилятор не находит подобные библиотеки